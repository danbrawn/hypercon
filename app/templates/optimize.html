{% extends 'base.html' %}
{% block content %}
<h1>Recipe Optimization</h1>

<div class="mb-3">
  <strong>Schema:</strong> {{ schema }}<br>
  <strong>Table:</strong> {{ table_name }}
</div>

<form id="opt-form" action="{{ url_for('optimize_bp.run') }}" method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <div class="mb-2">
    <button type="button" id="select-all" class="btn btn-sm btn-secondary">Select All</button>
    <button type="button" id="unselect-all" class="btn btn-sm btn-secondary">Unselect All</button>
  </div>

  <table class="table table-striped" id="materials-table">
    <thead>
      <tr>
        {% for col in columns %}
          <th>{{ col == 'use' and 'Select' or col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          <td><input type="checkbox" class="use-chk" value="{{ row['id'] }}" checked></td>
          {% for col in columns[1:] %}
            <td>{{ row[col] }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="mb-3">
    <h5>Constraints</h5>
    <table class="table table-sm" id="constraints-table">
      <thead><tr><th>Material</th><th>Operator</th><th>Value</th></tr></thead>
      <tbody id="constraints-body"></tbody>
    </table>
    <button type="button" id="add-constr" class="btn btn-secondary">Add Constraint</button>
  </div>

  <button id="run" type="button" class="btn btn-primary">Run</button>
  <div id="spinner" class="d-none mt-2">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Working...</span>
    </div>
  </div>
  <div id="time-info" class="mt-3 p-3 bg-light rounded">
    <div class="small"><strong>Estimated time:</strong> <span id="est-time">-</span></div>
    <div id="elapsed-wrap" class="small d-none"><strong>Elapsed:</strong> <span id="elapsed-time">0s</span></div>
  </div>
</form>

<div id="result" class="d-none">
  <h3>Result</h3>
  <p id="best-mse"></p>
  <table class="table table-sm" id="weights-table">
    <thead>
      <tr><th>Material ID</th><th>Weight %</th></tr>
    </thead>
    <tbody id="weights-body"></tbody>
  </table>
  <canvas id="chart" width="600" height="300"></canvas>
</div>

<script id="materials-data" type="application/json">
  [
  {% for r in rows %}{"id": {{ r['id'] }}, "name": "{{ r['material_name'] }}"}{% if not loop.last %},{% endif %}{% endfor %}
  ]
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='optimize.js') }}"></script>
{% endblock %}
