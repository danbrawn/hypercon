{% extends 'base.html' %}
{% block content %}
<h1>Оптимизация на рецепта</h1>

<div class="mb-3">
  <strong>Схема:</strong> {{ schema }}<br>
  <strong>Таблица:</strong> {{ table_name }}
</div>

<form id="opt-form" action="{{ url_for('optimize_bp.run') }}" method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <button id="run" class="btn btn-primary">Стартирай</button>
</form>

<div id="result" style="display:none;">
  <h3>Резултат</h3>
  <p id="best-mse"></p>
  <table class="table table-sm" id="weights-table">
    <thead>
      <tr><th>Материал ID</th><th>Тегло %</th></tr>
    </thead>
    <tbody id="weights-body"></tbody>
  </table>
  <canvas id="chart" width="600" height="300"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const form = document.getElementById('opt-form');
form.addEventListener('submit', e => {
  e.preventDefault();
  const formData = new FormData(form);
  fetch(form.action, {
    method: 'POST',
    body: formData
  })
    .then(r => r.json())
    .then(showResult);
});

function showResult(res){
  document.getElementById('result').style.display='block';

  // числова информация
  document.getElementById('best-mse').textContent = `Best MSE: ${res.best_mse}`;
  const tbody = document.getElementById('weights-body');
  tbody.innerHTML = '';
  res.material_ids.forEach((id,i)=>{
    const row = document.createElement('tr');
    row.innerHTML = `<td>${id}</td><td>${(res.weights[i]*100).toFixed(2)}%</td>`;
    tbody.appendChild(row);
  });

  // графика
  new Chart(document.getElementById('chart'),{
    type:'line',
    data:{
      labels: res.prop_columns,
      datasets:[
        { label:'Target', data: res.target_profile, borderColor:'red', fill:false },
        { label:'Mixed',  data: res.mixed_profile, borderColor:'blue', fill:false }
      ]
    }
  });
}
</script>
{% endblock %}
