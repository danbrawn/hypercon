{% extends 'base.html' %}
{% block title %}Оптимизация{% endblock %}
{% block content %}
<h1>Оптимизация на рецепта</h1>

<form id="opt-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <h3>1. Избери материали</h3>
  {% for m in materials %}
    <label>
      <input type="checkbox" name="selected" value="{{m.id}}" checked>
      {{ m.material_name }}
    </label><br>
  {% endfor %}

  <h3>2. Ограничения</h3>
  <div id="constraints"></div>
  <button type="button" id="add-constraint">Добави ограничение</button>
  <button type="button" id="reset-constraints">Нулирай</button>

  <h3>3. Граница на свойства</h3>
  От
  <select id="prop-min">
    {% for col in prop_columns %}
      <option value="{{ col }}">{{ col }}</option>
    {% endfor %}
  </select>
  До
  <select id="prop-max">
    {% for col in prop_columns %}
      <option value="{{ col }}">{{ col }}</option>
    {% endfor %}
  </select>

  <h3>4. Параметри на оптимизацията</h3>
  <label>MAX_COMBINATIONS
    <input type="number" id="max-comb" value="{{ default_max_comb }}" min="1">
  </label>
  <label>MSE_THRESHOLD
    <input type="number" id="mse-threshold" step="0.0001" value="{{ default_mse_thr }}">
  </label>

  <button type="submit">Стартирай</button>
</form>

<div id="progress" style="display:none;">
  Прогрес: <span id="pct">0</span>%
  Най-добро MSE: <span id="best-mse">-</span>
  <button type="button" id="stop-btn">Спри</button>
</div>

<div id="result" style="display:none;">
  <h3>Резултат</h3>
  <pre id="text-result"></pre>
</div>

<script>
(() => {
  const form = document.getElementById('opt-form');
  let pollInterval = null;
  let currentJobId = null;

  form.addEventListener('submit', e => {
    e.preventDefault();
    const selected = [...form.selected].filter(ch=>ch.checked).map(ch=>ch.value);
    const constraints = {}; // събирай от допълнителните полета
    const params = {
      selected_ids: selected,
      constraints,
      prop_min: parseFloat(document.getElementById('prop-min').value),
      prop_max: parseFloat(document.getElementById('prop-max').value),
      max_combinations: parseInt(document.getElementById('max-comb').value),
      mse_threshold: parseFloat(document.getElementById('mse-threshold').value)
    };
    fetch('/optimize/start', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': form.csrf_token.value
      },
      body: JSON.stringify(params)
    })
    .then(r => {
      if (!r.ok) return r.json().then(err => { throw err; });
      return r.json();
    })
      .then(data => {
        if (data.job_id) {
          poll(data.job_id);
        } else if (data.result) {
          showResult(data.result);
        }
      })
    .catch(err => alert(err.error || 'Грешка при стартиране'));
  });

  document.getElementById('stop-btn').addEventListener('click', () => {
    if (currentJobId) {
      fetch(`/optimize/cancel/${currentJobId}`, {method:'POST'}).then(() => {
        clearInterval(pollInterval);
        alert('Процесът е спрян');
      });
    }
  });

  function poll(job_id) {
    currentJobId = job_id;
    document.getElementById('progress').style.display = 'block';
    pollInterval = setInterval(() =>
      fetch(`/optimize/status/${job_id}`)
        .then(r => r.json())
        .then(data => {
          if (data.status === 'SUCCESS') {
            clearInterval(pollInterval);
            showResult(data.result);
          } else if (data.status === 'PROGRESS' && data.meta) {
            const pct = Math.round(100 * data.meta.current / data.meta.total);
            document.getElementById('pct').textContent = pct;
            document.getElementById('best-mse').textContent = data.meta.best_mse.toFixed(6);
          } else {
            document.getElementById('pct').textContent = '...';
          }
        }), 1000);
  }

  function showResult(res) {
    if (res.error) {
      alert(res.error);
      return;
    }
    document.getElementById('pct').textContent = '100';
    if (res.progress && res.progress.length) {
      const last = res.progress[res.progress.length - 1];
      document.getElementById('best-mse').textContent = last.best_mse.toFixed(6);
    }
    const text = `\nMSE: ${res.mse.toFixed(6)}\n` + res.material_ids.map((id,i)=>
      `Material ${id}: ${(res.weights[i]*100).toFixed(2)}%`
    ).join('\n');
    document.getElementById('text-result').textContent = text;
    document.getElementById('result').style.display = 'block';

  }
})();
</script>
{% endblock %}
